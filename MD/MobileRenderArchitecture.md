# üèóÔ∏è Mobile-First Render Architecture (Data-Driven & Customizable)

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Render Architecture ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö:
1.  **Multiple Workflows**: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á Anime, PBR, Foliage, ‡πÅ‡∏•‡∏∞ Custom Effects
2.  **Material Editor**: ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Material ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ Shader Code ‡πÅ‡∏ö‡∏ö Real-time
3.  **Mobile Optimized**: ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (Static Branching @ Compile time)

---

## 1. Concept Overview: "Uber-Shader" vs "Shader Graph"

‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mobile Engine ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏ï‡πà‡∏ß‡∏¥‡πà‡∏á 60 FPS ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö **Hybrid**:
*   **Core**: ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á **Template-based Shader**
*   **Editor**: ‡∏™‡∏£‡πâ‡∏≤‡∏á Shader Variant ‡∏à‡∏≤‡∏Å Data

### üìê The Architecture

```mermaid
graph TD
    A[Asset Database] -->|Load .shader / .mat| B(Material System)
    B -->|Generate| C[Render Pipeline Cache]
    C -->|Bind| D[Render Graph]
    D -->|Execute| E[WGPU Pass]
    
    User[Editor User] -->|Edit Code/Props| B
    B -->|Hot Reload| C
```

---

## 2. Implementation Modules

### 2.1 üé® Material System (The "Asset" Layer)
‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ä‡πâ `ToonMaterial` ‡∏´‡∏£‡∏∑‡∏≠ `PbrMaterial` ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Struct ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô **Generic Material**

**File Format (`.mat` JSON):**
```json
{
  "shader": "shaders/anime_character.wgsl",
  "pipeline_state": {
    "cull_mode": "Back",
    "blend": "AlphaBlending"
  },
  "properties": {
    "u_BaseColor": [1.0, 1.0, 1.0, 1.0],
    "u_OutlineWidth": 0.02,
    "t_MainTex": "textures/hero_d.png",
    "t_SDF": "textures/face_sdf.png"
  }
}
```

**Rust Implementation:**
```rust
pub struct Material {
    pub shader_id: AssetId,
    pub bind_group: wgpu::BindGroup, // Created dynamically based on shader layout
    pub properties: HashMap<String, UniformValue>,
}
```

### 2.2 üîÆ Shader System (Real-time Compilation)
‡πÉ‡∏´‡πâ Engine ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå `.wgsl` ‡∏î‡∏¥‡∏ö‡πÜ ‡πÅ‡∏•‡∏∞ "Inject" engine-params ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

**User Shader Code (`custom_toon.wgsl`):**
```wgsl
// @binding(0) group(2) -> Auto-generated by Engine depending on metadata
// User just writes the logic

#import engine_scene // Include camera, lights, time

@fragment
fn fs_main(in: VertexOutput) -> @location(0) vec4<f32> {
    let N = normalize(in.normal);
    let L = engine_scene.main_light_dir;
    let ramp = textureSample(t_Ramp, s_Ramp, vec2(dot(N, L) * 0.5 + 0.5, 0.0));
    return ramp * u_BaseColor;
}
```

**Hot-Reloading System:**
1.  Editor: User ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç text ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå `.wgsl` -> Save
2.  FileWatcher: Detect change
3.  ShaderCompiler:
    *   Pre-process code (Resolve `#import`)
    *   Reflect Variables (‡∏´‡∏≤ Uniforms ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ)
    *   Recreate `wgpu::RenderPipeline`
4.  MaterialSystem: Update material BindGroups ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ Shader ‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ

---

## 3. üï∏Ô∏è Render Graph (Flexible Workflows)
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á `GodOfWarWind` (Compute) ‡πÅ‡∏•‡∏∞ `AnimeOutline` (2-Pass) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ Code Rust ‡∏ö‡πà‡∏≠‡∏¢‡πÜ

**Engine Config (`render_graph.yaml`):**
```yaml
passes:
  - name: "WindSimulation"
    type: "Compute"
    shader: "shaders/wind_sim.wgsl"
    frequency: "EveryOtherFrame" # Mobile optimization

  - name: "ShadowPass"
    type: "Raster"
    output: "DepthStencil"

  - name: "OpaquePass"
    type: "Raster"
    inputs: ["WindSimulation", "ShadowPass"] # Dependency
    draw: ["Opaque", "Cutout"]

  - name: "TransparentPass"
    type: "Raster"
    draw: ["Transparent"]
```

---

## 4. üì± Mobile Specific Optimizations
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö Dynamic ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô Spec:

1.  **Uber-Shader Macros:**
    *   ‡∏ï‡∏≠‡∏ô Compile Shader ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà `#define MOBILE_TIER_HIGH` ‡∏´‡∏£‡∏∑‡∏≠ `#define USE_INSTANCING` ‡∏•‡∏á‡πÑ‡∏õ‡πÉ‡∏ô shader string ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ WGPU
    *   ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏°‡∏µ 1 Shader File ‡πÅ‡∏ï‡πà‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ó‡∏∏‡∏Å Device

2.  **Pipeline Caching:**
    *   Pipeline Creation ‡∏ö‡∏ô WGPU ‡πÅ‡∏û‡∏á‡∏°‡∏≤‡∏Å (Compile async)
    *   Engine ‡∏ï‡πâ‡∏≠‡∏á Cache Pipeline ‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏ß‡∏¢ Hash ‡∏Ç‡∏≠‡∏á (ShaderCode + RenderState + Layout) ‡∏ñ‡πâ‡∏≤ Hash ‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà

3.  **BindGroup Frequency:**
    *   Group 0: Global (Camera, Time, Wind) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Frame ‡∏•‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    *   Group 1: Material (Textures, Props) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏° Obj
    *   Group 2: Object (Transform) - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏∏‡∏Å Obj (‡πÉ‡∏ä‡πâ Dynamic Offset ‡∏ä‡πà‡∏ß‡∏¢)

---

## 5. Workflow Example

1.  **Artist** ‡πÄ‡∏õ‡∏¥‡∏î Editor -> Create New Material -> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Shader `Anime_Ultra.wgsl`
2.  **Shader Dev** ‡πÄ‡∏õ‡∏¥‡∏î Editor -> ‡πÅ‡∏Å‡πâ `Anime_Ultra.wgsl` ‡πÄ‡∏û‡∏¥‡πà‡∏° logic "Rim Light"
3.  ‡∏Å‡∏î Save -> ‡∏à‡∏≠ Game View ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö 1 ‡∏ó‡∏µ (Recompile Pipeline) -> ‡πÄ‡∏´‡πá‡∏ô Rim Light ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
4.  **Game Logic** ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Rim Light? -> `material.set_float("u_RimIntensity", 0.5)`

---

## ‚úÖ Action Plan

1.  **Refactor `MeshRenderer`**: ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô `create_pipeline` ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô `ShaderManager`
2.  **Refactor `Material`**: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å Struct ‡∏ï‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÄ‡∏õ‡πá‡∏ô `GenericMaterial` ‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠ `Buffer` ‡∏î‡∏¥‡∏ö
3.  **Implement `FileWatcher`**: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Hot-Reload .wgsl files
4.  **UI**: ‡∏™‡∏£‡πâ‡∏≤‡∏á Material Inspector ‡∏ó‡∏µ‡πà Generate UI ‡∏ï‡∏≤‡∏° Uniform ‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏ô Shader
